pipeline {
  agent any
  environment {
    // Docker Hub repo prefix (will be set later from credential username)
    IMAGE_BACKEND = ""
    IMAGE_FRONTEND = ""
  }
  stages {
    stage('Checkout') {
      steps { checkout scm }
    }

    stage('Build Backend (Maven)') {
      steps {
        dir('backend') {
          sh 'mvn -B clean package -DskipTests=true'
        }
      }
    }

    stage('Build Frontend (npm)') {
      steps {
        dir('frontend') {
          sh 'npm ci'
          sh 'npm run build'
        }
      }
    }

    stage('Docker Build & Push') {
      steps {
        // login to docker hub using Jenkins credentials with id 'dockerhub'
        withCredentials([usernamePassword(credentialsId: 'dockerhub', usernameVariable: 'DOCKERHUB_USER', passwordVariable: 'DOCKERHUB_PASS')]) {
          script {
            // set image names with BUILD_NUMBER tag
            env.IMAGE_BACKEND = "${DOCKERHUB_USER}/monitor-backend:${BUILD_NUMBER}"
            env.IMAGE_FRONTEND = "${DOCKERHUB_USER}/monitor-frontend:${BUILD_NUMBER}"

            sh 'echo "$DOCKERHUB_PASS" | docker login -u "$DOCKERHUB_USER" --password-stdin'

            // build backend
            sh "docker build -t ${env.IMAGE_BACKEND} backend -f backend/Dockerfile"

            // build frontend (production build copied into image by Dockerfile)
            sh "docker build -t ${env.IMAGE_FRONTEND} frontend -f frontend/Dockerfile"

            // push images
            sh "docker push ${env.IMAGE_BACKEND}"
            sh "docker push ${env.IMAGE_FRONTEND}"
          }
        }
      }
    }

    stage('Deploy to Kubernetes') {
      steps {
        // kubeconfig must be stored in Jenkins as a 'Secret file' credential with id 'kubeconfig'
        withCredentials([file(credentialsId: 'kubeconfig', variable: 'KUBECONFIG_FILE')]) {
          script {
            // install kubeconfig locally for this step
            sh 'mkdir -p $HOME/.kube'
            sh 'cp $KUBECONFIG_FILE $HOME/.kube/config'
            sh 'kubectl version --client'

            // replace image placeholders in k8s manifests and apply
            sh """
              # substitute images into manifest templates (requires envsubst or sed)
              sed 's|REPLACE_BACKEND_IMAGE|${env.IMAGE_BACKEND}|g' k8s/backend-deployment.yaml | kubectl apply -f -
              sed 's|REPLACE_FRONTEND_IMAGE|${env.IMAGE_FRONTEND}|g' k8s/frontend-deployment.yaml | kubectl apply -f -
              kubectl apply -f k8s/backend-service.yaml
              kubectl apply -f k8s/frontend-service.yaml
              kubectl apply -f k8s/ingress.yaml || true
            """
          }
        }
      }
    }
  }

  post {
    success {
      echo "Pipeline finished successfully. Backend -> ${env.IMAGE_BACKEND}, Frontend -> ${env.IMAGE_FRONTEND}"
    }
    failure {
      echo "Pipeline failed. Check logs."
    }
  }
}

